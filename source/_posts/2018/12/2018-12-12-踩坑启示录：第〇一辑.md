---
title: 踩坑启示录： 第〇一辑
categories:
  - Lin.C经验集之坑过我系列
tags:
  - 踩坑记
comments: true
abbrlink: 2b6f4e2b
date: 2018-12-12 08:20:43
---
【引言】此为踩坑启示录系列的第〇一辑，共计问题数10篇。
<div align=center><img src="/img/2018/2018-12-20-01.jpg" width="500"/></div>
<!-- more -->

# Maven编译时找不到rt.jar里的类

**【问题缘起】**
&emsp;&emsp;在使用Maven编译tools-common包的时候，发现某个类始终报找不到，经过查询，发现该类属于rt.jar，如何解决这个问题呢？

**【解决方法】**
&emsp;&emsp;在pom.xml的maven编译插件定义中，加入了compilerArguments定义引入rt.jar（另需要在pom头部定义java.home为当前主机的java主目录方可编译通过）
```xml
<plugin>
     <artifactId>maven-compiler-plugin</artifactId>
     <version>3.5.1</version>
     <configuration>
        <source>1.7</source>
        <target>1.7</target>
        <encoding>utf8</encoding>
        <compilerArguments>
           <verbose />
           <bootclasspath>${java.home}\lib\rt.jar;${java.home}\lib\jce.jar
           </bootclasspath>
        </compilerArguments>
     </configuration>
 </plugin>
 ```

# JDK的Date比实际时间差8小时

**【问题缘起】**
&emsp;&emsp;在记录某些数据更新时间时，使用JDK的new Date()方法，发现在未设置时间时，记录的时间默认比当前时间要推迟8小时（推测基本上是因为标准时间和东八区的差异引起的），那要如何解决呢？

**【解决方法】**
&emsp;&emsp;在系统上执行以下命令： sudo dpkg-reconfigure tzdata

# The last packet sent successfully to the server was 0 milliseconds ago

**【问题缘起】**
&emsp;&emsp;今天在使用JDBC操作mysql时遇到下面的异常信息： 
```
The last packet sent successfully to the server was 0 milliseconds ago. The driver has not received any packets from the server. 
at com.tomymap.galaxy.virgo.util.DbService.getConnection(DbService.java:66) 
at com.tomymap.galaxy.virgo.util.DbService.getConnection(DbService.java:46) 
at com.tomymap.galaxy.virgo.dao.PNNDao.getConnection(PNNDao.java:51) 
at com.tomymap.galaxy.virgo.dao.DaoBase.executeUpdate(DaoBase.java:69) 
at com.tomymap.galaxy.virgo.dao.PNNDao.updatePNNRelation(PNNDao.java:161) 
at com.tomymap.galaxy.virgo.pnn.PyramidNeuralNetwork.buildPNNRelations(PyramidNeuralNetwork.java:400)
at com.tomymap.galaxy.virgo.pnn.PyramidNeuralNetwork.incrementalGenPNN(PyramidNeuralNetwork.java:144)
at com.tomymap.galaxy.virgo.pnn.PyramidNeuralNetwork.main(PyramidNeuralNetwork.java:410)
```

**【解决方法】**
（1）使用JDBC URL中使用autoReconnect属性，url添加`&autoReconnect=true&failOverReadOnly=false&maxReconnects=10`
（2） 修改MySQL的参数. /etc/my.cnf 添加如下配置后重启服务`service mysql restart `
```
[mysqld]  
wait_timeout=31536000  
interactive_timeout=31536000  
```

**【补充说明】**
（1）大量并发访问情况下，mysql connection连接有可能失效 
（2）长时间不妨问，connection会失效 

# Maven编译插件如何配置？

**【问题缘起】**
&emsp;&emsp;需要使用Maven编译出jar、source、jdoc三个包，该如何配置pom文件？

**【解决方法】**
&emsp;&emsp;在pom.xml的尾部添加如下部分配置即可：
```xml
<build>
    <plugins>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <version>3.6.1</version>
            <configuration>
                <source>1.8</source>
                <target>1.8</target>
                <compilerArguments>
                    <verbose />
                    <bootclasspath>${java.home}/lib/rt.jar;${java.home}/lib/jce.jar</bootclasspath>
                </compilerArguments>
            </configuration>
        </plugin>
        <plugin>
            <artifactId>maven-source-plugin</artifactId>
            <version>3.0.1</version>
            <configuration>
                <attach>true</attach>
            </configuration>
            <executions>
                <execution>
                    <phase>compile</phase>
                    <goals>
                        <goal>jar</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
        <plugin>
            <artifactId>maven-javadoc-plugin</artifactId>
            <version>2.9</version>
            <configuration>
                <charset>UTF-8</charset>
                <docencoding>UTF-8</docencoding>
            </configuration>
            <executions>
                <execution>
                    <id>attach-javadocs</id>
                    <goals>
                        <goal>jar</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

# Tomcat启动时卡在“INFO Deploying web application directory ”

**【问题缘起】**
&emsp;&emsp;Tomcat启动时卡在“INFO: Deploying web application directory ”

**【解决方法】**
&emsp;&emsp;在 $JAVA_HOME/jre/lib/security/java.security内,将securerandom.source的内容改为file:/dev/./urandom

**【补充说明】**
&emsp;&emsp;原来linux或者部分unix系统提供随机数设备是/dev/random 和/dev/urandom ，两个有区别，urandom安全性没有random高，但random需要时间间隔生成随机数。可能在生成随机数的时候卡住了,导致tomcat启动不了，在服务器启动时也可以加上参数 -Djava.security.egd=file:/dev/./urandom 

# 怎么通过Java临时修改环境变量？

**【问题缘起】**
&emsp;&emsp;因某些特殊场景需要，需在程序中临时修改环境变量，如何通过Java来实现呢？

**【解决方法】**
```java
/* 
 * 文件名：EnviromentChangeUtil.java
 * 描述：环境变量修改
 * 创建人：chenglin
 * 创建时间：2017-3-10
 */
package com.demo;

import java.lang.reflect.Field;
import java.util.Collections;
import java.util.Map;

/**
 * 临时修改系统环境变量（仅对内存生效）
 * @author chenglin
 * @version 1.0
 * 
 * <br/>
 * <br/>修订人		修订时间			描述信息
 * <br/>-----------------------------------------------------
 * <br/>chenglin		2017-3-10		初始创建
 */

public class EnviromentChangeUtil {

    /**
     * 临时修改系统环境变量（仅对内存生效）
     * @param envMap
     */
    @SuppressWarnings({ "unchecked", "rawtypes" })
    public static void setEnv(Map<String, String> envMap) {
        try {
            Class<?> processEnvironmentClass = Class
                    .forName("java.lang.ProcessEnvironment");
            Field theEnvironmentField = processEnvironmentClass
                    .getDeclaredField("theEnvironment");
            theEnvironmentField.setAccessible(true);
            Map<String, String> env = (Map<String, String>) theEnvironmentField
                    .get(null);
            env.putAll(envMap);
            Field theCaseInsensitiveEnvironmentField = processEnvironmentClass
                    .getDeclaredField("theCaseInsensitiveEnvironment");
            theCaseInsensitiveEnvironmentField.setAccessible(true);
            Map<String, String> cienv = (Map<String, String>) theCaseInsensitiveEnvironmentField
                    .get(null);
            cienv.putAll(envMap);
        } catch (NoSuchFieldException e) {
            try {
                Class[] classes = Collections.class.getDeclaredClasses();
                Map<String, String> env = System.getenv();
                for (Class cl : classes) {
                    if ("java.util.Collections$UnmodifiableMap".equals(cl
                            .getName())) {
                        Field field = cl.getDeclaredField("m");
                        field.setAccessible(true);
                        Object obj = field.get(env);
                        Map<String, String> map = (Map<String, String>) obj;
                        map.clear();
                        map.putAll(envMap);
                    }
                }
            } catch (Exception e2) {
                e2.printStackTrace();
            }
        } catch (Exception e1) {
            e1.printStackTrace();
        }
    }
}
```

# Tomcat 8.5+版本文件上传后无权限访问的问题

**【问题缘起】**
&emsp;&emsp;之前在tomcat 7下文件上传后访问一直没问题，现在tomcat版本升到8.5，在测试文件http上传时，发现所传文件无法通过nginx访问了。PS：tomcat通过root用户来启动。（Tomcat默认写的文件权限是740，实际访问需要的是755）

**【解决方法】**
&emsp;&emsp;在catalina.sh文件的大约第270行左右有下面一段配置，这里的UMASK就是用于管理文件访问权限的（实际权限为：777-UMASK）；所以将其改为UMASK=”0022”并重启tomcat 8.5后，文件上传后访问恢复正常。
```bash
# UMASK           (Optional) Override Tomcat's default UMASK of 0027
# Set UMASK unless it has been overridden
if [ -z "$UMASK" ]; then
    UMASK="0027"
fi
umask $UMASK
```

**【补充说明】**
&emsp;&emsp;英文文档也是在定位了tomcat 8.5问题后搜索关键词tomcat8.5 umask后在tomcat官网文档及相关英文论坛里发现了踪迹。
&emsp;&emsp;参考文档1： http://tomcat.apache.org/tomcat-8.5-doc/changelog.html 
```
Tomcat 8.5.0 (markt)
General
Update:  Remove support for Comet. (markt)
Update:  Tighten up the default file permissions for the .tar.gz distribution so no files or directories are world readable by default. 
         Configure Tomcat to run with a default umask of 0027 which may be overridden by setting UMASK in setenv.sh. (markt)
Update:  Remove native code (Windows Service Wrapper, APR/native connector) support for Windows Itanium. (markt)
```
&emsp;&emsp;参考文档2：http://tomcat.apache.org/tomcat-8.5-doc/security-howto.html 
```
Non-Tomcat settings
Tomcat configuration should not be the only line of defense. The other components in the system (operating system, network, database, etc.) should also be secured.

Tomcat should not be run under the root user. Create a dedicated user for the Tomcat process and provide that user with the minimum necessary permissions for the operating system. 
For example, it should not be possible to log on remotely using the Tomcat user.

File permissions should also be suitably restricted. In the .tar.gz distribution, files and directories are not world readable and the group does not have write access.
On Unix like operating systems, Tomcat runs with a default umask of 0027 to maintain these permissions for files created while Tomcat is running (e.g. log files, expanded WARs, etc.).
...
```