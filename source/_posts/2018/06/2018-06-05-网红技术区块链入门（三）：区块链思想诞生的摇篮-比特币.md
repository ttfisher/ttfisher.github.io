---
title: 网红技术区块链入门（三）：区块链思想诞生的摇篮-比特币
comments: true
categories:
  - Broaden Horizon - Popular Technologies
tags:
  - 区块链
abbrlink: dc926d56
date: 2018-06-05 12:30:36
---
【引言】作为近两年的大热技术点，区块链如今也是越吵越火爆，区块链的大热和比特币或多或少存在着千丝万缕的联系，今天我们就来对比特币一探究竟吧！
<img style="clear: both;display: block;margin:auto;" src="/img/2018/2018-06-05-08.jpg" width="500">
<!-- more -->

# 从比特币的诞生说起
&emsp;&emsp;近些年比特币的概念，作为普通老百姓可能是没什么了解，但是作为一个互联网或者说IT从业者，应该多多少少都有些耳闻的，那么比特币具体是什么呢？它是怎么实现的呢？为什么说区块链都要提到比特币呢？
&emsp;&emsp;从概念上讲，比特币是一种网络虚拟货币，而它所生存依赖的网络正是由区块链技术支撑实现的去中心化对等匿名网络；在这个网络上，有人挖矿，有人做交易，一切都是公开透明的。
&emsp;&emsp;从技术上阐述的话，比特币（BitCoin，BTC）是基于区块链技术的一种数字货币实现；比特币网络是历史上首个经过大规模长时间检验的数字货币系统。

# 比特币的特点
+ 去中心化：意味着没有任何独立个体可以对网络中交易进行破坏，任何交易请求都需要大多数参与者的共识；
+ 匿名性：比特币网络中账户地址是匿名的，无法从交易信息关联到具体的个体，但这也意味着很难进行审计；
+ 通胀预防：比特币的发行需要通过挖矿计算来进行，发行量每四年减半，总量上限为2100 万枚，无法被超发。

# 比特币的重要概念

## 账户/地址
&emsp;&emsp;比特币采用了非对称的加密算法，用户自己保留私钥，对自己发出的交易进行签名确认，并公开公钥。比特币的账户地址其实就是用户公钥经过一系列 Hash（HASH160，或先进行 SHA256，然后进行 RIPEMD160）及编码运算后生成的 160 位（20 字节）的字符串。
> 注：账户并非直接是公钥内容，而是 Hash 后的值，避免公钥过早公开后导致被破解出私钥。

## 交易
&emsp;&emsp;交易是完成比特币功能的核心概念，一条交易可能包括如下信息：
> 付款人地址：合法的地址，公钥经过 SHA256 和 RIPEMD160 两次 Hash，得到 160 位Hash 串；
付款人对交易的签字确认：确保交易内容不被篡改；
付款人资金的来源交易 ID：从哪个交易的输出作为本次交易的输入；
交易的金额：多少钱，跟输入的差额为交易的服务费；
收款人地址：合法的地址；
时间戳：交易何时能生效

&emsp;&emsp;网络中节点收到交易信息后，将进行如下检查：
> 交易是否已经处理过；
交易是否合法。包括地址是否合法、发起交易者是否是输入地址的合法拥有者、是否是UTXO；
交易的输入之和是否大于输出之和。
检查都通过，则将交易标记为合法的未确认交易，并在网络内进行广播。

## 交易脚本
&emsp;&emsp;脚本（Script） 是保障交易完成（主要用于检验交易是否合法）的核心机制，当所依附的交易发生时被触发。通过脚本机制而非写死交易过程，比特币网络实现了一定的可扩展性。比特币脚本语言是一种非图灵完备的语言，类似 Forth 语言。一般每个交易都会包括两个脚本：负责输入的解锁脚本（scriptSig）和负责输出的锁定脚本（scriptPubKey）。
&emsp;&emsp;输出脚本一般由付款方对交易设置锁定，用来对能动用这笔交易的输出（例如，要花费该交易的输出）的对象（收款方）进行权限控制，例如限制必须是某个公钥的拥有者才能花费这笔交易。
&emsp;&emsp;输出脚本目前支持两种类型：
> P2PKH：Pay-To-Public-Key-Hash，允许用户将比特币发送到一个或多个典型的比特币地址上（证明拥有该公钥），前导字节一般为 0x00；(eg: scriptPubKey: OP_DUP OP_HASH160 <pubKeyHash> OP_EQUALVERIFY OP_CHECKSIG)
P2SH：Pay-To-Script-Hash，支付者创建一个输出脚本，里边包含另一个脚本（认领脚本）的哈希，一般用于需要多人签名的场景，前导字节一般为 0x05；

## 区块
<img style="clear: both;display: block;margin:auto;" src="/img/2018/2018-06-05-09.jpg" width="90%">
&emsp;&emsp;比特币区块链的一个区块不能超过 1 MB，将主要包括如下内容：
> 区块大小：4 字节；
区块头：80 字节：
交易个数计数器：1~9 字节；
所有交易的具体内容，可变长，匹配 Merkle 树叶子节点顺序。

&emsp;&emsp;其中，区块头信息十分重要,要对区块链的完整性进行检查，只需要检验各个区块头部信息即可，无需获取到具体
的交易内容，这也是简单交易验证（Simple Payment Verification，SPV）的基本原理。区块头的内容包括：
> 版本号：4 字节；
上一个区块头的 Hash 值：链接到上一个合法的块上，对其区块头进行两次 SHA256 操作，32 字节；
本区块所包含的所有交易的 Merkle 树根的哈希值：两次 SHA256 操作，32 字节；
时间戳：4 字节；
难度指标：4 字节；
Nonce：4 字节，PoW 问题的答案。

## 挖矿
&emsp;&emsp;当用户向比特币网络中发布交易后，需要有人将交易进行确认，形成新的区块，串联到区块链中。在一个互相不信任的分布式系统中，该由谁来完成这件事情呢？比特币网络采用了“挖矿”的方式来解决这个问题。
&emsp;&emsp;挖矿的具体过程为：参与者综合上一个区块的 Hash 值，上一个区块生成之后的新的验证过的交易内容，再加上自己猜测的一个随机数 X，一起打包到一个候选新区块，让新区块的 Hash值小于比特币网络中给定的一个数。这是一道面向全体矿工的“计算题”，这个数越小，计算出来就越难。
<img style="clear: both;display: block;margin:auto;" src="/img/2018/2018-06-05-10.jpg" width="70%">

## 共识机制
&emsp;&emsp;比特币网络是完全公开的，任何人都可以匿名接入，因此共识协议的稳定性和防攻击性十分关键。比特币区块链采用了 Proof of Work（PoW）的机制来实现共识，该机制最早于 1998 年在 B-money 设计中提出。目前，Proof of X 系列中比较出名的一致性协议包括 PoW、PoS 和 DPoS 等，都是通过经济惩罚来限制恶意参与。

## 工作量证明
&emsp;&emsp;工作量证明，通过计算来猜测一个数值（nonce），使得拼凑上交易数据后内容的 Hash 值满足规定的上限（来源于 hashcash）。由于 Hash 难题在目前计算模型下需要大量的计算，这就保证在一段时间内，系统中只能出现少数合法提案。反过来，能够提出合法提案，也证明提案者确实已经付出了一定的工作量。
&emsp;&emsp;Hash 问题具有不可逆的特点，因此，目前除了暴力计算外，还没有有效的算法进行解决。反之，如果获得符合要求的 nonce，则说明在概率上是付出了对应的算力。谁的算力多，谁最先解决问题的概率就越大。当掌握超过全网一半算力时，从概率上就能控制网络中链的走向。这也是所谓51%攻击的由来。

## Pow一致性保证
&emsp;&emsp;打个比方，假定超市只有一个出口，付款时需要排成一队，可能有人不守规矩要插队。超市管理员会检查队伍，认为最长的一条队伍是合法的，并让不合法的分叉队伍重新排队。新到来的人只要足够理智，就会自觉选择最长的队伍进行排队。

## 侧链
&emsp;&emsp;侧链（Sidechain）协议允许资产在比特币区块链和其他区块链之间互转。简单来讲，以比特币区块链作为主链（Parent chain），其他区块链作为侧链（侧链可以是一个独立的区块链），二者通过双向挂钩（Two-way peg），可实现比特币从主链转移到侧链进行流通。
<img style="clear: both;display: block;margin:auto;" src="/img/2018/2018-06-05-11.jpg" width="80%">

## SPV 证明
&emsp;&emsp;SPV能够以较小的代价判断某个支付交易是否已经被验证过（存在于区块链中），以及得到了多少算力保护（定位包含该交易的区块在区块链中的位置）。SPV 客户端只需要下载所有区块的区块头（Block Header），并进行简单的定位和计算工作就可以给出验证结论。

# 比特币的交易流程图解

## 具象化流程概览
&emsp;&emsp;说比特币，实际我们更关注的是它的交易流程，那么下面这个图就是个很好的参考：
<img style="clear: both;display: block;margin:auto;" src="/img/2018/2018-06-05-01.jpg" width="80%">

## 实例化流程演示
<img style="clear: both;display: block;margin:auto;" src="/img/2018/2018-06-04-04.jpg" width="80%">
&emsp;&emsp;比如A要给B转账100块钱，会经历如下的流程
+ A会在网络上把要转账的这个信息告诉大家
+ 大家会去查看A的账户上是否有足够的钱去完成这个转账
+ 如果验证通过后，大家就把这个信息都记录到自己的电脑上区块链中，且每个人记入的信息都是同步一致的
+ 这样A就顺利将100块钱转移到了B的账户上（一旦有超过51%的矿工记录成功，这个链就正式记入了）

## 抽象化流程演示
<img style="clear: both;display: block;margin:auto;" src="/img/2018/2018-06-05-02.jpg" width="70%">
&emsp;&emsp;对应到电子货币上（也就是区块链环境中），流程又是什么样子的呢？
+ Owner 0's 将他的数字签名和 Owner 1's 的公钥附在了第一笔交易的尾端（从左到右）
+ 比特币系统验证无误后，这枚电子货币就属于了 Owner 1's。
+ Owner 1's 将他的数字签名和 Owner 2's 的公钥附在了第二笔交易的尾端
+ 比特币系统验证无误后，这枚电子货币就属于了 Owner 2's。
+ 第三笔交易也是类似...

## 抽象化交易细节
<img style="clear: both;display: block;margin:auto;" src="/img/2018/2018-06-05-03.jpg" width="80%">
&emsp;&emsp;交易主要包含四个独立的部分：
+ 黄色部分表示的是：hash - txid(Transaction ID)
+ 蓝色大括号表示的是：交易的描述信息和元数据
+ 粉红色部分表示的是：inputs
+ 绿色部分表示的是：outputs

### transaction的一般格式
|名称|描述|
|:--:|:--:|
|version|比特币系统的版本号|
|hash|本次交易的 hash 值|
|inputs|由 input 组成的数组|
|outputs|由 output 组成的数组|
|lockTime|值为0，立刻执行交易；值不为0，在指定区块高度或时间戳执行交易|

### output的数据格式
|名称|描述|
|:--:|:--:|
|value|电子货币的价值，单位 BTC|
|scriptPubKey|通常是收款人公钥等组成的锁定脚本|

### input的数据格式
|名称|描述|
|:--:|:--:|
|prevTxId|上一笔交易的 hash 值|
|outputIndex|上一笔交易 outputs 的 index|
|scriptSig|通常由付款人的数字签名和收款人的公钥等组成的解锁脚本|
